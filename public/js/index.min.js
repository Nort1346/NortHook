import*as e from"bootstrap";import{generateUniqueId as t,createMessageInput as s,createMessageVisual as a,createWebhookUrlInput as o,checkWebsiteSize as r,refreshAllLocalTimers as l,getSaveElement as n}from"./functions.min.js";import{TypeOfMessage as i,WebhookUrl as c}from"./classes.min.js";import{Message as u}from"./message.min.js";import{generalWebHookInfo as d,messages as v,successModalSend as f,successModalText as h,failModalSend as p,failModalContentSend as m}from"./variables.min.js";export let isAllWebhooksGood=!1;let saveNameInput=document.getElementById("saveNameInput"),saveDataButton=document.getElementById("saveDataButton"),savesContent=document.getElementById("savesContent"),searchSavesInput=document.getElementById("searchSavesInput"),sendButton=document.getElementById("sendButton"),tooltipList=[];export const webhooksUrl=[new c(0,document.getElementById("webhookUrl"),new e.Collapse("#InvalidWebhookUrlCollapse",{toggle:!1}))];async function send(){let e=document.getElementById("loadingMessage");e.classList.remove("visually-hidden"),sendButton.disabled=!0;let t=0;for(let s of webhooksUrl){let a=!1;for(let o of v)if(o.messageType==i.SEND){let r=await sendMessage(s.input.value,o.getMessage());if(!1==r.success){m.innerText=r.errorText,p.show(),a=!0;break}t++}else{let l=await editMessage(s.input.value,o.getMessage());if(!1==l.success){m.innerText=l.errorText,p.show(),a=!0;break}t++}if(a)break}v.length==t/webhooksUrl.length&&(t>1?h.innerHTML="Messages Sent":h.innerHTML="Message Sent",f.show()),e.classList.add("visually-hidden"),sendButton.disabled=!1}async function sendMessage(e,t){let s=new FormData,a={};if(a.content=t.content??null,""!=t.user.username.replaceAll(/\s/g,"")&&(a.username=t.user.username),""!=t.user.avatar_url.replaceAll(/\s/g,"")&&(a.avatar_url=t.user.avatar_url),t.files.length>10)return{success:!1,errorText:"Error: Max files is 10"};t?.embeds!=null&&(a.embeds=t.embeds);for(let o=0;o<t.files.length;o++)try{let r=new Blob([await t.files[o].arrayBuffer()],{type:t.files[o].type});s.append(`files${o}`,r,t.files[o].name)}catch(l){console.error(`Error in file ${o}:`,l)}s.append("payload_json",JSON.stringify(a));let n=await fetch(e,{method:"POST",body:s});return n.ok?{success:!0,errorText:null}:{success:!1,errorText:"Error: Message Invalid"}}async function editMessage(e,t){let s=new FormData,a={},o=`${e}/messages/${t.reference.slice(t.reference.lastIndexOf("/")+1)}`;if(t.files.length>10)return{success:!1,errorText:"Error: Max files is 10"};a.content=t.content??null,a.embeds=t.embeds??null,a.attachments=[];for(let r=0;r<t.files.length;r++)s.append("files",t.files[r]);for(let l=0;l<t.files.length;l++)try{let n=new Blob([await t.files[l].arrayBuffer()],{type:t.files[l].type});s.append(`files${l}`,n,t.files[l].name)}catch(i){console.error(`Error in file ${l}:`,i)}s.append("payload_json",JSON.stringify(a));let c=await fetch(o,{method:"PATCH",body:s});return c.ok?{success:!0,errorText:null}:{success:!1,errorText:"Error: Invalid Message"}}async function createMessage(){let e=t();v.push(new u(await s(e),await a(e),e)),l(),displayMessagesRemoveButton()}document.getElementById("clearAllMessages").addEventListener("click",clearAllMessages),document.getElementById("addMessage").addEventListener("click",async()=>await createMessage()),document.getElementById("addWebhook").addEventListener("click",addWebhook),sendButton.addEventListener("click",async()=>await send()),saveNameInput.addEventListener("input",checkSaveButtonName),searchSavesInput.addEventListener("input",()=>filterSaves(searchSavesInput.value)),saveDataButton.addEventListener("click",()=>saveData(saveNameInput.value)),window.addEventListener("resize",r),r(),createMessage(),loadAllSaves(),refreshTooltips();export async function checkWebhookUrl(e){if(isCorrectWebhookURL(e)){try{let t=await fetch(webhooksUrl[e].input.value,{method:"GET"}),s=200==t.status;if(s?webhooksUrl[e].alert.hide():webhooksUrl[e].alert.show(),webhooksUrl[e].verify=s,s){let a=await t.json();webhooksUrl[e].webHookInfo.name=a?.name,webhooksUrl[e].webHookInfo.avatar=a?.avatar!==null?`https://cdn.discordapp.com/avatars/${a.id}/${a.avatar}.webp?size=512`:"https://cdn.discordapp.com/embed/avatars/0.png",verifyWebhookUrls(),v.forEach(e=>{e.refreshWebhookInfo(),e.checkReference()});return}}catch(o){return}webhooksUrl[e].webHookInfo.name=null,webhooksUrl[e].webHookInfo.name=null,verifyWebhookUrls(),v.forEach(e=>{e.refreshWebhookInfo()})}}export function isCorrectWebhookURL(e){let t=webhooksUrl[e].input.value.replaceAll(/\s/g,"").startsWith("https://discord.com/api/webhooks/");return""==webhooksUrl[e].input.value.replaceAll(/\s/g,"")?webhooksUrl[e].alert.hide():!1==t&&webhooksUrl[e].alert.show(),t}export function isCorrectAllWebhookURL(){let e=!0;for(let t of webhooksUrl)!0===e&&(e=t.input.value.replaceAll(/\s/g,"").startsWith("https://discord.com/api/webhooks/")),""==t.input.value.replaceAll(/\s/g,"")?t.alert.hide():!1==e&&t.alert.show();return e}export function verifyWebhookUrls(){let e=!0;for(let t of webhooksUrl)if(!1==t.verify){e=!1,sendButton.disabled=!0,isAllWebhooksGood=!1,0==t.id&&(d.name=null,d.avatar=null);break}return webhooksUrl[0].verify?(d.name=webhooksUrl[0].webHookInfo.name,d.avatar=webhooksUrl[0].webHookInfo.avatar):(d.name=null,d.avatar=null),e&&(sendButton.disabled=!1,isAllWebhooksGood=!0),e}export function refreshTooltips(){tooltipList.map(e=>{e.dispose()});let t=document.querySelectorAll('[data-bs-toggle="tooltip"]');tooltipList=[...t].map(t=>new e.Tooltip(t,{trigger:"hover",delay:{show:100,hide:100}}))}export function removeMessage(e){let t=v.findIndex(t=>t.id==e);v[t].removeMessage(),v.splice(v.findIndex(t=>t.id==e),1),displayMessagesRemoveButton()}async function addWebhook(){let s=t(),a=await o(s),r=new c(s,a.querySelector(".webhookUrl"),new e.Collapse(a.querySelector(".InvalidWebhookUrlCollapse"),{toggle:!1}),a.querySelector(".removeButton"));r.removeButton.addEventListener("click",()=>r.removeWebhook()),webhooksUrl.push(r),refreshTooltips(),verifyWebhookUrls()}function getAllDataJSON(e){let t={version:1,save:{name:e,messages:null,targets:null}};return t.save.messages=[].concat(...v.map(e=>e.getMessageData())),t.save.targets=[].concat(...webhooksUrl.map(e=>({url:e.input.value}))),t}async function loadAllDataJSON(e){let t=JSON.parse(localStorage.getItem(e));if(""!==t){for(let[s,a]of(clearAllWebhooks(),t.save.targets.entries()))0!==s&&await addWebhook(),webhooksUrl[s].input.value=a.url,await checkWebhookUrl(s);for(let[o,r]of(verifyWebhookUrls(),clearAllMessages(),t.save.messages.entries()))0!==o&&await createMessage(),v[o].setMessageFromData(r)}}async function saveData(e){if(""===e)return;let t=getAllDataJSON(e);if(localStorage.setItem(`${e}`,JSON.stringify(t)),null!==savesContent.querySelector(`[id="saveElement_${e}"]`))return;saveNameInput.value="",checkSaveButtonName();let s=await n(),a=generateSaveElement(e,s);checkEmptySaves(),savesContent.appendChild(a),refreshTooltips()}async function removeSaveData(e){savesContent.querySelector(`[id="saveElement_${e}"]`).remove(),localStorage.removeItem(e),checkEmptySaves(),refreshTooltips()}async function exportSaveData(e){let t=JSON.stringify(JSON.parse(localStorage.getItem(e)),null,4);if(null==t)return;let s=new Blob([t],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=e,a.click(),window.URL.revokeObjectURL(a.href)}function checkEmptySaves(){if(0==localStorage.length){let e=document.createElement("div");return e.classList.add("noSavesElement"),e.innerHTML="You've yet to create any backups. Provide a name below and click the Save button to initiate one.",savesContent.appendChild(e),!1}{let t=savesContent.querySelector(".noSavesElement");return t&&t.remove(),localStorage.length>5?savesContent.classList.remove("overflow-y-visible"):savesContent.classList.add("overflow-y-visible"),!0}}async function loadAllSaves(){let e=Object.keys(localStorage),t=e.map(e=>JSON.parse(localStorage.getItem(e)));if(checkEmptySaves()){savesContent.innerHTML="";let s=await n();for(let a of t)savesContent.appendChild(generateSaveElement(a.save.name,s));refreshTooltips()}}export function removeWebhook(e){document.getElementById(`webhookUrl_${e}`).remove();let t=webhooksUrl.findIndex(t=>t.id==e);-1!==t&&webhooksUrl.splice(t,1),verifyWebhookUrls(),refreshTooltips()}function filterSaves(e){let t=savesContent.querySelectorAll(".saveElement");t.forEach(t=>{let s=t.querySelector(".saveName").innerText.toLowerCase();s.includes(e.toLowerCase())?t.classList.remove("d-none"):t.classList.add("d-none")})}function generateSaveElement(e,t){let s=document.createElement("li");return s.id=`saveElement_${e}`,s.innerHTML=t,s.querySelector(".saveName").innerText=e,s.querySelector(".saveLoadButton").addEventListener("click",()=>loadAllDataJSON(e)),s.querySelector(".removeSaveButton").addEventListener("click",()=>removeSaveData(e)),s.querySelector(".exportSaveButton").addEventListener("click",()=>exportSaveData(e)),s.querySelector(".overrideSaveButton").addEventListener("click",()=>saveData(e)),s.classList.add("saveElement","list-group-item"),s}function checkSaveButtonName(){localStorage.getItem(saveNameInput.value)?saveDataButton.innerText="Override":saveDataButton.innerText="Save"}function clearAllWebhooks(){webhooksUrl.forEach((e,t)=>{0!==t?document.getElementById(`webhookUrl_${e.id}`).remove():e.input.value=""}),webhooksUrl.splice(1),refreshTooltips(),verifyWebhookUrls()}function clearAllMessages(){v.forEach((e,t)=>{0!=t?e.removeMessage():(e.clearMessage(),e.toggleRemoveMessageButtonDisplay(!1))}),v.slice(1)}function displayMessagesRemoveButton(){let e=v.length>1;v.forEach(t=>t.toggleRemoveMessageButtonDisplay(e))}