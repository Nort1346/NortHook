import{isImageURLValid as e,generateUniqueId as t,createEmbedInput as s,createEmbedVisual as i,insertAfter as a,formatText as r,formatBytes as n,getFileVisual as d}from"./functions.min.js";import{TypeOfMessage as l}from"./classes.min.js";import{refreshTooltips as h,removeMessage as o,webhooksUrl as m,isAllWebhooksGood as u}from"./index.min.js";import{defaultWebhookInfo as c,generalWebHookInfo as b}from"./variables.min.js";import{Embed as E}from"./embed.min.js";import*as v from"bootstrap";export class Message{constructor(e,t,a){this.id=a,this.messageInputElement=e,this.messageVisualElement=t,this.content=e.querySelector(".content"),this.username=e.querySelector(".username"),this.avatar_url=e.querySelector(".avatar_url"),this.files=e.querySelector(".files"),this.reference=e.querySelector(".messageLink"),this.embeds=[],this.messageType=l.SEND,this.loadMessageButton=e.querySelector(".loadMessageButton"),this.clearFilesButton=e.querySelector(".clearFiles"),this.addEmbedButton=e.querySelector(".addEmbed"),this.removeMessageButton=e.querySelector(".removeMessage"),this.contentView=t.querySelector(".contentView"),this.usernameView=t.querySelector(".usernameName"),this.avatarView=t.querySelector(".avatarIcon"),this.filesView=t.querySelector(".filesView"),this.alertInvalidAvatarUrl=new v.Collapse(`#messageInput_${this.id} .InvalidAvatarUrlCollapse`,{toggle:!1}),this.alertInvalidMessageLink=new v.Collapse(`#messageInput_${this.id} .InvalidMessageLinkCollapse`,{toggle:!1}),this.content.addEventListener("input",async()=>await this.refreshView()),this.username.addEventListener("input",async()=>await this.refreshView()),this.avatar_url.addEventListener("input",async()=>await this.refreshView()),this.reference.addEventListener("input",()=>this.checkReference()),this.loadMessageButton.addEventListener("click",()=>this.loadMessage()),this.clearFilesButton.addEventListener("click",async()=>this.clearFiles()),this.addEmbedButton.addEventListener("click",async()=>this.addEmbed(await s(this.messageInputElement),await i(this.messageVisualElement))),this.removeMessageButton.addEventListener("click",()=>{o(this.id)}),this.jsonEditorButton=e.querySelector(".jsonEditor"),this.jsonEditorJSON=e.querySelector(".jsonEditorJSON"),this.jsonEditorModal=new v.Modal(`#messageInput_${this.id} .jsonEditorInput`),this.jsonEditorExecuteChangesButton=e.querySelector(".jsonEditorExecuteChanges"),this.jsonEditorError=e.querySelector(".jsonEditorError"),this.jsonEditorButton.addEventListener("click",()=>{this.jsonEditorModal.show(),this.jsonEditorJSON.value=JSON.stringify(this.getMessageJSON(),null,3)}),this.jsonEditorJSON.addEventListener("input",()=>this.checkJsonInputErrors()),this.jsonEditorExecuteChangesButton.addEventListener("click",async()=>{await this.setMessageJSON(JSON.parse(this.jsonEditorJSON.value))}),this.files.addEventListener("fileInput",async()=>this.refreshFilesVisual()),this.files.addEventListener("change",async()=>this.refreshFilesVisual()),this.webhookInfo={name:null,avatar:null},this.setStandardValues(),this.refreshWebhookInfo()}async setMessageFromMessageObject(e){this.content.value=e.content,this.username.value=e.author.username,this.avatar_url.value=`https://cdn.discordapp.com/avatars/${e.author.id}/${e.author.avatar}.png`,this.embeds.forEach(e=>e.removeEmbed()),this.embeds.splice(0,this.embeds.length);for(let t=0;t<e.embeds.length&&t<10;t++)await this.addEmbed(await s(this.messageInputElement),await i(this.messageVisualElement)),await this.embeds[t].setEmbed(e.embeds[t]);this.clearFiles(),this.countEmbedNumbers(),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),this.refreshFilesVisual(),this.refreshView()}async setMessageJSON(e){if(this.content.value=await e.content?.substring(0,2e3),this.username.value=await e?.username?.substring(0,80)??"",this.avatar_url.value=await e?.avatar_url?.substring(0,2048)??"",this.embeds.forEach(e=>e.removeEmbed()),null!==e.embeds){this.embeds.splice(0,this.embeds.length);for(let t=0;t<e.embeds.length&&t<10;t++)await this.addEmbed(await s(this.messageInputElement),await i(this.messageVisualElement)),await this.embeds[t].setEmbed(e.embeds[t])}this.clearFiles(),this.countEmbedNumbers(),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),this.refreshFilesVisual(),await this.refreshView()}async setMessageFromData(e){if(this.content.value=await e?.data.content?.substring(0,2e3),this.username.value=await e?.data.user?.username?.substring(0,80)??"",this.avatar_url.value=await e?.data.user?.avatar_url?.substring(0,2048)??"",this.embeds.forEach(e=>e.removeEmbed()),null!==e.data.embeds){this.embeds.splice(0,this.embeds.length);for(let t=0;t<e.data.embeds.length&&t<10;t++)await this.addEmbed(await s(this.messageInputElement),await i(this.messageVisualElement)),await this.embeds[t].setEmbed(e.data.embeds[t])}this.reference.value=await e?.reference,this.clearFiles(),this.countEmbedNumbers(),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),this.refreshFilesVisual(),this.checkReference(),await this.refreshView()}getMessage(){return{content:this.content.value,user:{username:this.username.value,avatar_url:this.avatar_url.value},embeds:[].concat(...this.embeds.map(e=>e.getEmbed()))??null,files:this.files.files,reference:this.reference.value}}getMessageJSON(){let e={content:this.content.value,embeds:this.embeds.length>0?[].concat(...this.embeds.map(e=>e.getEmbed())):null};return""!==this.username.value.trimStart()&&(e.username=this.username.value),""!==this.avatar_url.value.trimStart()&&(e.avatar_url=this.avatar_url.value),e}getMessageData(){return{data:{content:this.content.value,user:{username:this.username.value,avatar_url:this.avatar_url.value},embeds:[].concat(...this.embeds.map(e=>e.getEmbed()))??null},reference:this.reference.value}}async loadMessage(){let e=document.getElementById("loadingMessage");e.classList.remove("visually-hidden"),this.loadMessageButton.disabled=!0;let t=`${m[0].input.value}/messages/
        ${this.reference.value.slice(this.reference.value.lastIndexOf("/")+1)}`,s=await fetch(t,{method:"GET",cache:"no-store"});if(e.classList.add("visually-hidden"),this.loadMessageButton.disabled=!1,s.ok){let i=await s.json();await this.setMessageFromMessageObject(i)}}async refreshView(){this.contentView.innerHTML=r(this.content.value),""!=this.username.value.replaceAll(/\s/g,"")?this.usernameView.innerText=this.username.value:this.usernameView.innerText=this.webhookInfo.name??c.name,""!=this.avatar_url.value.replaceAll(/\s/g,"")?await e(this.avatar_url.value)?(this.alertInvalidAvatarUrl.hide(),this.avatarView.src=this.avatar_url.value):(this.alertInvalidAvatarUrl.show(),this.avatarView.src=this.webhookInfo.avatar??c.avatar):(this.alertInvalidAvatarUrl.hide(),this.avatarView.src=this.webhookInfo.avatar??c.avatar)}async refreshFilesVisual(){for(let e of(this.filesView.innerHTML="",this.files.files)){let t=document.createElement("div");if(t.classList.add("w-100"),t.classList.add("my-1"),e.type.startsWith("image/")){let s=document.createElement("img");s.classList.add("rounded"),s.style.width="auto",s.style.height="auto",s.style.maxWidth="90%",s.style.maxHeight="400px",s.src=URL.createObjectURL(e),s.alt=e.name,t.appendChild(s)}else{let i=await d();t.innerHTML=i,t.querySelector(".fileName").innerHTML=e.name.substring(0,30),t.querySelector(".fileSize").innerHTML=n(e.size)}this.filesView.appendChild(t)}}refreshWebhookInfo(){this.webhookInfo.name=b.name,this.webhookInfo.avatar=b.avatar,this.refreshView()}setStandardValues(){this.content.value="Hello World, I am Developer",this.refreshView()}async addEmbed(e,s){let i=t(),a=new E(e,s,i);await a.setEmbedNumber(this.embeds.length),this.embeds.push(a),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),h(),a.upButton.addEventListener("click",()=>this.upEmbed(a.id)),a.downButton.addEventListener("click",()=>this.downEmbed(a.id)),a.removeButton.addEventListener("click",()=>this.removeEmbed(a.id)),a.duplicateButton.addEventListener("click",async()=>await this.duplicateEmbed(a.id))}upEmbed(e){let t=this.embeds.findIndex(t=>t.id==e);if(t>=0){let s=this.embeds.splice(t,1)[0];this.embeds.splice(t-1,0,s),this.embeds[t].inputEmbed.insertAdjacentElement("beforebegin",this.embeds[t-1].inputEmbed),this.embeds[t].visualEmbed.insertAdjacentElement("beforebegin",this.embeds[t-1].visualEmbed),this.checkArrowsEmbeds(),this.countEmbedNumbers(),h()}}downEmbed(e){let t=this.embeds.findIndex(t=>t.id==e);if(t>=0){let s=this.embeds.splice(t,1)[0];this.embeds.splice(t+1,0,s),this.embeds[t].inputEmbed.insertAdjacentElement("afterend",this.embeds[t+1].inputEmbed),this.embeds[t].visualEmbed.insertAdjacentElement("afterend",this.embeds[t+1].visualEmbed),this.checkArrowsEmbeds(),this.countEmbedNumbers(),h()}}removeEmbed(e){let t=this.embeds.findIndex(t=>t.id==e);t>=0&&(this.embeds[t].removeEmbed(),this.embeds.splice(t,1),this.countEmbedNumbers(),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),h())}async duplicateEmbed(e){let r=this.embeds.findIndex(t=>t.id==e);if(r>=0&&this.embeds.length<10){let n=new E(await s(this.messageInputElement),await i(this.messageVisualElement),t());await n.setEmbed(this.embeds[r].getEmbed()),await n.refreshEmbedVisual(),n.upButton.addEventListener("click",()=>this.upEmbed(n.id)),n.downButton.addEventListener("click",()=>this.downEmbed(n.id)),n.removeButton.addEventListener("click",()=>this.removeEmbed(n.id)),n.duplicateButton.addEventListener("click",async()=>await this.duplicateEmbed(n.id)),this.embeds.splice(r+1,0,n),this.countEmbedNumbers(),this.checkAddEmbedButton(),this.checkArrowsEmbeds(),a(n.inputEmbed,this.embeds[r].inputEmbed),a(n.visualEmbed,this.embeds[r].visualEmbed),h()}}checkArrowsEmbeds(){this.embeds.map((e,t)=>{e.upButton.disabled=!1,e.upButton.classList.remove("d-none"),e.downButton.disabled=!1,e.downButton.classList.remove("d-none"),0==t&&(e.upButton.disabled=!0,e.upButton.classList.add("d-none")),t==this.embeds.length-1&&(e.downButton.disabled=!0,e.downButton.classList.add("d-none"))})}checkAddEmbedButton(){this.embeds.length>=10?this.addEmbedButton.disabled=!0:this.addEmbedButton.disabled=!1}countEmbedNumbers(){for(let e=0;e<this.embeds.length;e++)this.embeds[e].setEmbedNumber(e)}async checkReference(){if(u&&this.isCorrectReference(this.reference.value)){let e=`${m[0].input.value}/messages/
          ${this.reference.value.slice(this.reference.value.lastIndexOf("/")+1)}`,t=await fetch(e,{method:"GET"});if(this.loadMessageButton.disabled=!t.ok,t.ok){await t.json(),this.messageType=l.EDIT,this.alertInvalidMessageLink.hide(),this.refreshView();return}}this.messageType=l.SEND,this.loadMessageButton.disabled=!0,""==this.reference.value.replaceAll(/\s/g,"")?this.alertInvalidMessageLink.hide():this.alertInvalidMessageLink.show(),this.refreshView()}isCorrectReference(e){return e.replaceAll(/\s/g,"").startsWith("https://discord.com/channels/")}removeMessage(){this.messageInputElement.remove(),this.messageVisualElement.remove(),this.embeds.forEach(e=>{e.removeEmbed()})}toggleRemoveMessageButtonDisplay(e){e?this.removeMessageButton.classList.remove("d-none"):this.removeMessageButton.classList.add("d-none")}clearFiles(){this.files.value=null,this.refreshFilesVisual()}clearMessage(){this.content.value="",this.username.value="",this.avatar_url.value="",this.clearFiles(),this.embeds.forEach(e=>{e.removeEmbed()}),this.embeds.splice(0),this.reference.value="",this.checkReference()}checkJsonInputErrors(){try{return JSON.parse(this.jsonEditorJSON.value),this.jsonEditorExecuteChangesButton.disabled=!1,this.jsonEditorError.innerText="",!0}catch(e){return this.jsonEditorExecuteChangesButton.disabled=!0,this.jsonEditorError.innerText=e.message,!1}}}