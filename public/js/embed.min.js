import{generateUniqueId as e,isImageURLValid as t,formatText as i,getFieldInput as l,getFieldVisual as s}from"./functions.min.js";import{refreshTooltips as r}from"./index.min.js";export class Embed{constructor(e,t,i){this.inputEmbed=e,this.visualEmbed=t,this.setId(i),this.embedNumber=e.querySelector(".embedId"),this.embedName=e.querySelector(".embedName"),this.removeButton=e.querySelector(".embedButtonRemove"),this.duplicateButton=e.querySelector(".embedButtonDuplicate"),this.upButton=e.querySelector(".embedButtonUp"),this.downButton=e.querySelector(".embedButtonDown"),this.addFieldButton=e.querySelector(".addFieldButton"),this.author={name:e.querySelector(".authorName"),url:e.querySelector(".authorUrl"),icon_url:e.querySelector(".authorIconUrl")},this.title=e.querySelector(".title"),this.description=e.querySelector(".description"),this.color=e.querySelector(".color"),this.url=e.querySelector(".url"),this.fields=[],this.timestamp=e.querySelector(".timestamp"),this.image={url:e.querySelector(".imagesUrl")},this.thumbnail={url:e.querySelector(".thumbnailUrl")},this.footer={text:e.querySelector(".footerText"),icon_url:e.querySelector(".footerIconUrl")},this.viewObjects={color:this.visualEmbed.querySelector(".colorVisual"),title:this.visualEmbed.querySelector(".titleVisual"),description:this.visualEmbed.querySelector(".descriptionVisual"),url:this.visualEmbed.querySelector(".urlVisual"),timestamp:this.visualEmbed.querySelector(".timestampVisual"),footer:{text:this.visualEmbed.querySelector(".footerTextVisual"),iconUrl:this.visualEmbed.querySelector(".footerIconUrlVisual"),url:this.visualEmbed.querySelector(".footerUrlVisual"),allElements:this.visualEmbed.querySelector(".footer")},thumbnail:{url:this.visualEmbed.querySelector(".thumbnailVisual")},image:{url:this.visualEmbed.querySelector(".imageVisual")},author:{name:this.visualEmbed.querySelector(".authorNameVisual"),iconUrl:this.visualEmbed.querySelector(".authorIconUrlVisual"),url:this.visualEmbed.querySelector(".authorUrlVisual"),allElements:this.visualEmbed.querySelector(".author")}},this.#a()}getEmbed(){let e={};return this.author.name.value&&(e.author={name:this.author.name.value,url:this.author.url.value,icon_url:this.author.icon_url.value}),this.title.value&&(e.title=this.title.value),this.description.value&&(e.description=this.description.value),this.color.value&&(e.color=parseInt(this.color.value.slice(1),16)),this.url.value&&(e.url=this.url.value),this.timestamp.value&&(e.timestamp=new Date(this.timestamp.value)),this.image.url.value&&(e.image={url:this.image.url.value}),this.thumbnail.url.value&&(e.thumbnail={url:this.thumbnail.url.value}),this.footer.text.value&&(e.footer={text:this.footer.text.value,icon_url:this.footer.icon_url.value}),this.fields.length>0&&(e.fields=this.getFields()),e}async setEmbed(e){this.author.name.value=e?.author?.name?.substring(0,256)??"",this.author.url.value=e?.author?.url?.substring(0,2048)??"",this.author.icon_url.value=e?.author?.icon_url?.substring(0,2048)??"",this.title.value=e?.title?.substring(0,256)??"",this.description.value=e?.description?.substring(0,2048)??"",this.color.value=("#"+e?.color?.toString(16)?.padStart(6,"0"))??"",this.url.value=e?.url?.substring(0,2e3)??"";let t=new Date(e?.timestamp);isNaN(t.getTime())||(this.timestamp.value=t?.toISOString()?.slice(0,16)??""),this.image.url.value=e?.image?.url?.substring(0,2048)??"",this.thumbnail.url.value=e?.thumbnail?.url?.substring(0,256)??"",this.footer.text.value=e?.footer?.text??"",this.footer.icon_url.value=e?.footer?.icon_url??"",e?.fields!=null&&e.fields?.length>0&&await this.setFields(e?.fields),await this.refreshEmbedVisual()}async refreshEmbedVisual(){this.title.value?this.embedName.innerText=`- ${this.title.value}`:this.embedName.innerText="",this.viewObjects.color.style.backgroundColor=this.color.value,this.viewObjects.title.innerHTML=i(this.title.value),this.title.value?this.viewObjects.title.classList.remove("d-none"):this.viewObjects.title.classList.add("d-none"),this.url.value?(this.viewObjects.url.href=this.url.value,this.viewObjects.url.classList.remove("text-decoration-none"),this.viewObjects.url.onclick="return false;"):(this.viewObjects.url.classList.add("text-decoration-none"),this.viewObjects.url.onclick=""),this.viewObjects.description.innerHTML=i(this.description.value),this.timestamp.value||this.footer.text.value?(this.viewObjects.timestamp.innerText=this.timestamp.value?new Date(this.timestamp.value).toLocaleString():"",this.viewObjects.footer.allElements.classList.remove("d-none"),this.viewObjects.footer.text.innerText=this.footer.text.value,await t(this.footer.icon_url.value)?(this.viewObjects.footer.iconUrl.src=this.footer.icon_url.value,this.viewObjects.footer.iconUrl.classList.remove("d-none")):this.viewObjects.footer.iconUrl.classList.add("d-none")):this.viewObjects.footer.allElements.classList.add("d-none"),await t(this.thumbnail.url.value)?(this.viewObjects.thumbnail.url.src=this.thumbnail.url.value,this.viewObjects.thumbnail.url.classList.remove("d-none")):this.viewObjects.thumbnail.url.classList.add("d-none"),await t(this.image.url.value)?(this.viewObjects.image.url.src=this.image.url.value,this.viewObjects.image.url.classList.remove("d-none")):this.viewObjects.image.url.classList.add("d-none"),this.author.name.value?(this.viewObjects.author.allElements.classList.remove("d-none"),this.viewObjects.author.name.innerText=this.author.name.value,await t(this.author.icon_url.value)?(this.viewObjects.author.iconUrl.src=this.author.icon_url.value,this.viewObjects.author.iconUrl.classList.remove("d-none")):this.viewObjects.author.iconUrl.classList.add("d-none")):this.viewObjects.author.allElements.classList.add("d-none");for(let e=0;e<this.fields.length;e++)this.fields[e].fieldVisual.name.innerHTML=i(this.fields[e].name.value),this.fields[e].fieldVisual.value.innerHTML=i(this.fields[e].value.value),this.fields[e].inline.checked?this.fields[e].fieldVisual.colElementInline.classList.remove("col-12"):this.fields[e].fieldVisual.colElementInline.classList.add("col-12")}#a(){this.inputEmbed.addEventListener("input",()=>this.refreshEmbedVisual()),this.addFieldButton.addEventListener("click",async()=>this.addField())}getFields(){return this.fields.map(e=>({name:e.name.value,value:e.value.value,inline:e.inline.checked}))}async addField(t=null){let i=e(),u=await l(),a=document.createElement("div");a.id=`fieldInput_${i}`,a.innerHTML=u,a.querySelector(".fieldButtonParameters").setAttribute("data-bs-target",`#${a.id} .fieldBody`),a.querySelector(".fieldInline").setAttribute("id",`fieldInline_${i}`),a.querySelector(".fieldInlineLabel").setAttribute("for",`fieldInline_${i}`),a.querySelector(".fieldButtonRemove").addEventListener("click",async()=>await this.removeField(i)),a.querySelector(".fieldButtonDuplicate").addEventListener("click",async()=>await this.duplicateField(i)),a.querySelector(".fieldButtonUp").addEventListener("click",async()=>this.fieldUp(i)),a.querySelector(".fieldButtonDown").addEventListener("click",async()=>this.fieldDown(i)),a.querySelector(".fieldName").addEventListener("input",()=>this.countAndTitleAllFields()),t&&(a.querySelector(".fieldName").value=t.name,a.querySelector(".fieldValue").value=t.value,a.querySelector(".fieldInline").checked=t.inline);let n=await s(),d=document.createElement("div");return d.id=`fieldVisual_${i}`,d.innerHTML=n,d.classList.add("col"),this.fields.push({id:i,name:a.querySelector(".fieldName"),value:a.querySelector(".fieldValue"),inline:a.querySelector(".fieldInline"),fieldNumber:a.querySelector(".fieldNumber"),fieldRemoveButton:a.querySelector(".fieldButtonRemove"),fieldUpButton:a.querySelector(".fieldButtonUp"),fieldDownButton:a.querySelector(".fieldButtonDown"),fieldTitle:a.querySelector(".fieldTitle"),fieldVisual:{id:i,name:d.querySelector(".fieldVisualName"),value:d.querySelector(".fieldVisualValue"),colElementInline:d}}),await this.countAndTitleAllFields(),await this.checkMaxFields(),await this.checkArrowsFields(),document.querySelector(`#embedInput${this.id} .fieldsContent`).appendChild(a),document.querySelector(`#embedVisual${this.id} .fieldsContent`).appendChild(d),r(),i}removeField(e){let t=this.fields.findIndex(t=>t.id==e);this.fields.splice(t,1),document.getElementById(`fieldInput_${e}`).remove(),document.getElementById(`fieldVisual_${e}`).remove(),this.countAndTitleAllFields(),this.checkMaxFields(),r()}async duplicateField(e){if(this.fields.length<25){let t=this.fields.findIndex(t=>t.id==e);await this.addField({name:this.fields[t].name.value,value:this.fields[t].value.value,inline:this.fields[t].inline.checked}),this.countAndTitleAllFields(),this.checkMaxFields(),this.refreshEmbedVisual()}}fieldUp(e){let t=this.fields.findIndex(t=>t.id==e);if(t>=0){let i=this.fields.splice(t,1)[0];this.fields.splice(t-1,0,i),document.getElementById(`fieldInput_${e}`).insertAdjacentElement("afterend",document.getElementById(`fieldInput_${this.fields[t].id}`)),document.getElementById(`fieldVisual_${e}`).insertAdjacentElement("afterend",document.getElementById(`fieldVisual_${this.fields[t].id}`)),this.countAndTitleAllFields(),this.checkArrowsFields()}}fieldDown(e){let t=this.fields.findIndex(t=>t.id==e);if(t>=0){let i=this.fields.splice(t,1)[0];this.fields.splice(t+1,0,i),document.getElementById(`fieldInput_${e}`).insertAdjacentElement("beforebegin",document.getElementById(`fieldInput_${this.fields[t].id}`)),document.getElementById(`fieldVisual_${e}`).insertAdjacentElement("beforebegin",document.getElementById(`fieldVisual_${this.fields[t].id}`)),this.countAndTitleAllFields(),this.checkArrowsFields()}}async setFields(e){this.fields=[];for(let t=0;t<e.length;t++)await this.addField({name:e[t].name,value:e[t].value,inline:e[t].inline})}async checkArrowsFields(){this.fields.map((e,t)=>{e.fieldUpButton.disabled=!1,e.fieldUpButton.classList.remove("d-none"),e.fieldDownButton.disabled=!1,e.fieldDownButton.classList.remove("d-none"),0==t&&(e.fieldUpButton.disabled=!0,e.fieldUpButton.classList.add("d-none")),t==this.fields.length-1&&(e.fieldDownButton.disabled=!0,e.fieldDownButton.classList.add("d-none"))})}async countAndTitleAllFields(){let e=1;for(let t of this.fields)t.fieldNumber.innerText=`Field ${e} `,""!==t.name.value.trimStart()?t.fieldTitle.innerText=`- ${t.name.value.trimStart().trimEnd().substring(0,20)}`:t.fieldTitle.innerText="",e++}async checkMaxFields(){this.fields.length>=25?this.addFieldButton.disabled=!0:this.addFieldButton.disabled=!1}async setEmbedNumber(e){this.embedNumber.innerText=`Embed ${e+1} `,this.refreshEmbedVisual()}setId(e){this.id=e,this.inputEmbed.id="embedInput"+e,this.visualEmbed.id="embedVisual"+e,this.inputEmbed.querySelector(".embedButtonCollapse").setAttribute("data-bs-target",`#${this.inputEmbed.id} .embedCollapse`),this.inputEmbed.querySelector(".authorButtonOptions").setAttribute("data-bs-target",`#${this.inputEmbed.id} .authorOptions`),this.inputEmbed.querySelector(".bodyButtonOptions").setAttribute("data-bs-target",`#${this.inputEmbed.id} .bodyOptions`),this.inputEmbed.querySelector(".fieldsButtonOptions").setAttribute("data-bs-target",`#${this.inputEmbed.id} .fieldsOptions`),this.inputEmbed.querySelector(".imagesButtonOptions").setAttribute("data-bs-target",`#${this.inputEmbed.id} .imagesOptions`),this.inputEmbed.querySelector(".footerButtonOptions").setAttribute("data-bs-target",`#${this.inputEmbed.id} .footerOptions`)}removeEmbed(){this.inputEmbed.remove(),this.visualEmbed.remove()}}